<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>プレイ準備</title>
    <style>
      body { background-color: #555; color: #555; font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
      /* 元のデザイン設定 */
      canvas { background: #006e54; display: block; margin: 20px auto; border: 2px solid #fff; max-width: 90vw; }
      button { padding: 15px 30px; font-size: 1.2rem; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; margin-top: 20px; }
      button:active { background: #3e8e41; }
      button:disabled { background: #888; cursor: not-allowed; }
    </style>
  </head>
  <body>

    <canvas id="screen" width="600" height="400"></canvas>
    <br>
    <button id="startBtn" onclick="startFromWeb()">▶ スタート (ブラウザ経由)</button>

    <script>
      // GASから渡されたURL
      const EXEC_URL = '<?= EXEC_URL ?>';

      // --- 画面の描画（元のCanvas処理） ---
      window.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        
        // 緑色の背景
        ctx.fillStyle = '#006e54';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 白文字
        ctx.fillStyle = 'white';
        ctx.font = '40px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('M5Tone Web Player', canvas.width/2, 180);
        
        ctx.font = '20px Arial';
        ctx.fillText('下のボタンを押すとゲームを開始します', canvas.width/2, 240);
      });

      // --- ゲーム開始処理（ここだけ最新ロジックに変更） ---
      function startFromWeb() {
        const btn = document.getElementById('startBtn');
        btn.disabled = true; // 連打防止
        btn.innerText = "準備中...";

        // サーバー側の関数を呼び出し
        google.script.run
          .withSuccessHandler(function(response) {
             const res = JSON.parse(response);
             
             if (res.status === 'ok' && res.session_id) {
               // ★ここが重要：発行された session_id をURLに付けて notes へ遷移
               window.top.location.href = EXEC_URL + '?page=notes&session=' + res.session_id;
             } else {
               alert("エラーが発生しました: " + response);
               btn.disabled = false;
               btn.innerText = "▶ スタート (ブラウザ経由)";
             }
          })
          .withFailureHandler(function(err) {
            alert("通信エラー: " + err);
            btn.disabled = false;
            btn.innerText = "▶ スタート (ブラウザ経由)";
          })
          .startFromWebWithGAS("Player"); // プレイヤー名は固定または入力フォームから取得
      }
    </script>
  </body>
</html>
