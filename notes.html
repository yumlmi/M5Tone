<script>
  const sessionId = "<?= sessionId ?>";
  const resultUrl = "<?= resultPageUrl ?>";

  function goToResult() {
    console.log("Redirecting to:", resultUrl);
    window.top.location.href = resultUrl;
  }

  function startSequence() {
    console.log("Video started. Waiting 68 seconds...");

    setTimeout(function() {
      console.log("68 seconds passed. Starting status check...");

      // オーバーレイ表示
      document.getElementById("overlay").style.display = "flex";
      document.getElementById("status-text").innerText = "結果を集計中...";

      const pollTimer = setInterval(function() {
        console.log("Checking session status for:", sessionId);

        google.script.run
          .withSuccessHandler(function(res) {
            console.log("Server Response:", res);

            if (res && (res.ended === true || res.ended === "true")) {
              clearInterval(pollTimer);

              //  自動遷移しない
              //  ボタンを表示するだけ
              document.getElementById("status-text").innerText = "集計が完了しました";
              document.getElementById("manualBtn").style.display = "block";
            }
          })
          .withFailureHandler(function(err) {
            console.error("GAS Error:", err);

            // エラー時もボタンは出す
            document.getElementById("status-text").innerText = "結果を表示できます";
            document.getElementById("manualBtn").style.display = "block";
          })
          .checkSessionEnded(sessionId);
      }, 2500);

    }, 68000);
  }

  window.onload = startSequence;
</script>
